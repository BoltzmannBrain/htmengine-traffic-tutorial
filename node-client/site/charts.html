---
title: HTM Engine Traffic Tutorial
layout: main.hbt
---

<script src="{{baseurl}}/bower_components/dygraphs/extras/synchronizer.js"></script>

<link href="{{baseurl}}/css/charts.css" rel="stylesheet">

<div id="title">
    <h2>All Traffic Routes</h2>
</div>

<table class="charts">
    <tbody>

    </tbody>
</table>

<script type="text/javascript">
    $(function() {

        function getJsonFromUrl() {
            var query = location.search.substr(1);
            var result = {};
            query.split("&").forEach(function(part) {
                var item = part.split("=");
                result[item[0]] = decodeURIComponent(item[1]);
            });
            return result;
        }

        var graphs = [];
        var query = getJsonFromUrl();

        function goChart(id, details) {
            var csvPath;

            $('table.charts tbody').append(
                    "<tr><td class='left'>" + "<h4>" + "<a href='{{ baseurl }}/map?id=" + id +
                    "' target='_blank'>" + id + "</a> " + "(" + details.Borough + ")" + "</h4>" + "<br/>" +
                    details.linkName + "</td><td class='right' id='container-" + id + "'>" + "<div id='chart-" +
                    id + "'></div>" + "</td></tr>"
            );

            csvPath = '/data/' + id + '?' + $.param(query);

            graphs.push(new Dygraph(
                document.getElementById("chart-" + id), csvPath, {
                    anomaly: {
                        color: "red",
                        axis: {
                            valueRange: [0, 1.0]
                        }
                    },
                    axes: {
                        y: {
                            valueRange: [0, 80]
                        }
                    },
                    width: $('#container-' + id).width(),
                    height: 120,
                    underlayCallback: function(canvas, area, g) {
                        var yellow = "rgba(255, 255, 102, 1.0)";

                        function highlight_period(x_start, x_end) {
                            var canvas_left_x = g.toDomXCoord(x_start);
                            var canvas_right_x = g.toDomXCoord(x_end);
                            var canvas_width = canvas_right_x - canvas_left_x;
                            canvas.fillRect(canvas_left_x, area.y, canvas_width, area.h);
                        }

                        var min_data_x = g.getValue(0, 0);
                        var max_data_x = g.getValue(g.numRows() - 1, 0);

                        // get day of week
                        var d = new Date(min_data_x);
                        var dow = d.getUTCDay();

                        var w = min_data_x;
                        // starting on Sunday is a special case
                        if (dow === 0) {
                            highlight_period(w, w + 12 * 3600 * 1000);
                        }
                        // find first saturday
                        while (dow != 6) {
                            w += 24 * 3600 * 1000;
                            d = new Date(w);
                            dow = d.getUTCDay();
                        }
                        // shift back 1/2 day to center highlight around the point for the day
                        w -= 12 * 3600 * 1000;

                        canvas.fillStyle = yellow;
                        while (w < max_data_x) {
                            var start_x_highlight = w;
                            var end_x_highlight = w + 2 * 24 * 3600 * 1000;
                            // make sure we don't try to plot outside the graph
                            if (start_x_highlight < min_data_x) {
                                start_x_highlight = min_data_x;
                            }
                            if (end_x_highlight > max_data_x) {
                                end_x_highlight = max_data_x;
                            }
                            highlight_period(start_x_highlight, end_x_highlight);
                            // calculate start of highlight for next Saturday
                            w += 7 * 24 * 3600 * 1000;
                        }
                    }
                }
            ));
        }


        if (query.borough) {
            query.borough = query.borough.replace('%20', ' ');
            $('#title h1').html(query.borough);
        } else if (query.id) {
            $('#title h1').html('Route ' + query.id);
        }

        $.getJSON('{{ baseurl }}/data/pathDetails', query, function(data) {
            _.each(data.paths, function(pathData, pathId) {
                goChart(pathId, pathData);
            });
            var sync = Dygraph.synchronize(graphs, {
                selection: false,
                zoom: true
            });
        });

    });
</script>