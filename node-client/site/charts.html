---
title: HTM Engine Traffic Tutorial
layout: main.hbt
---

{{#each paths}}
    <div id="chart-{{@key}}"></div>
{{/each}}

<script type="text/javascript">
    $(function() {
        var $body = $('div#main')
          , docWidth = $(document).width();
        
        function goChart(id) {
            var csvPath = "/data/" + id;
            new Dygraph(
                document.getElementById("chart-" + id)
              , csvPath
              , { 
                    width: docWidth * 0.9
                  , anomaly: {
                        axis: {}
                      , color: "red"
                    }
                  , underlayCallback: function(canvas, area, g) {
                        var red = "rgba(247, 141, 184, 0.5)";
                        var yellow = "rgba(255, 255, 102, 1.0)";

                        function highlight_period(x_start, x_end) {
                            var canvas_left_x = g.toDomXCoord(x_start);
                            var canvas_right_x = g.toDomXCoord(x_end);
                            var canvas_width = canvas_right_x - canvas_left_x;
                            canvas.fillRect(canvas_left_x, area.y, canvas_width, area.h);
                        }

                        var min_data_x = g.getValue(0,0);
                        var max_data_x = g.getValue(g.numRows()-1,0);

                        // get day of week
                        var d = new Date(min_data_x);
                        var dow = d.getUTCDay();

                        var w = min_data_x;
                        // starting on Sunday is a special case
                        if (dow === 0) {
                            highlight_period(w,w+12*3600*1000);
                        }
                        // find first saturday
                        while (dow != 6) {
                            w += 24*3600*1000;
                            d = new Date(w);
                            dow = d.getUTCDay();
                        }
                        // shift back 1/2 day to center highlight around the point for the day
                        w -= 12*3600*1000;

                        canvas.fillStyle = yellow;
                        while (w < max_data_x) {
                            var start_x_highlight = w;
                            var end_x_highlight = w + 2*24*3600*1000;
                            // make sure we don't try to plot outside the graph
                            if (start_x_highlight < min_data_x) {
                                start_x_highlight = min_data_x;
                            }
                            if (end_x_highlight > max_data_x) {
                                end_x_highlight = max_data_x;
                            }
                            highlight_period(start_x_highlight,end_x_highlight);
                            // calculate start of highlight for next Saturday 
                            w += 7*24*3600*1000;
                        }

                        // Go back to beginning for this loop
                        canvas.fillStyle = red;

                        // THIS IS REALLY SLOW :(

                        // for (var i = min_data_x; i < max_data_x; i++) {
                        //     // console.log(i);
                        // }
                    }
                }
            );
        };

        {{#each paths}}
            goChart({{@key}});
        {{/each}}

    });
</script>