<!DOCTYPE html>
<html>
<head>

  <link href="{{baseurl}}/bower_components/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="{{baseurl}}/css/map.css" rel="stylesheet">
  <link href="{{baseurl}}/css/time.css" rel="stylesheet">
  <link href="{{baseurl}}/js/external/jQRangeSlider-5.7.1/css/iThing.css" type="text/css" rel="stylesheet" />

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <script src="{{baseurl}}/bower_components/lodash/lodash.min.js"></script>
  <script src="{{baseurl}}/bower_components/async/lib/async.js"></script>
  <script src="{{baseurl}}/bower_components/handlebars/handlebars.min.js"></script>
  <script src="{{baseurl}}/bower_components/moment/min/moment.min.js"></script>
  <script src="{{baseurl}}/bower_components/moment-timezone/builds/moment-timezone-with-data.min.js"></script>

  <script src="{{baseurl}}/bower_components/jquery-ui/jquery-ui.min.js"></script>

  <script src="{{baseurl}}/js/external/jQRangeSlider-5.7.1/jQDateRangeSlider-min.js"></script>

  <script src="{{baseurl}}/js/utils.js"></script>
  <script src="{{baseurl}}/js/map.js"></script>

  <script type="text/javascript"
    src="https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=true&libraries=places&key={{ googleApiKey }}">
  </script>
  <title></title>
</head>
  <body>

    <div id="title">
        <h1>All Routes</h1>
        <h4><a href="{{ baseurl }}">HOME</a></h4>
        <p>Each route has a marker at its first point. Click it to get more details.</p>
    </div>

    <!-- <input id="pac-input" class="controls" type="text" placeholder="Search Box"> -->

    <div id="slider"></div>
    <div id="map-canvas"></div>

    <script type="text/javascript">

    $(function() {

        var markerTemplate
          , pageTitle
          , mapOptions
          , query
          , map
          , now = moment()
          , $slider = $('#slider')
          ;

        $.get('{{ baseurl }}/templates/markerLabel.hbt', function(response) {
            markerTemplate = response;
        });

        query = getUrlVars();

        if (query.borough) {
            query.borough = query.borough.replace('%20',' ')
            pageTitle = 'Map of ' + query.borough;
        } else if (query.id) {
            pageTitle = 'Map of route(s): ' + query.id;
        }

        $('#title h1').html(pageTitle);
        $('title').html(pageTitle);

        map = new TrafficMap('map-canvas', '{{baseurl}}', {
            center: { lat: 40.7903, lng: -73.9597}
          , zoom: 11
        });

        // SLIDER
        sliderOpts = {
            bounds: {
                min: moment(now).subtract(2, 'days').toDate()
              , max: now.toDate()
            }
          , defaultValues: {
                min: moment(now).subtract(3, 'hours').toDate()
              , max: now.toDate()
            }
          , formatter: function(val){
              return moment(val).format('MMM D HH:mm');
            }
        };

        $slider.dateRangeSlider(sliderOpts);

        $.getJSON('{{ baseurl }}/data/pathDetails', query, function(data) {
            var minMax = $slider.dateRangeSlider('values');

            // map.enableSearchBox('pac-input');
            // map.enableRightClickSearch();

            map.setRoutePaths(data.paths, markerTemplate);
            _.each(map.routes, function(rte) {
                var color;
                $.get('{{ baseurl }}/data/' + rte.id, function(csv) {
                    rte.data = csvStringToData(csv);
                    console.log(rte.data);
                });
                color = getGreenToRed(0);
                rte.line.setOptions({strokeColor: '#' + color});
            });

        });

        function csvStringToData(csv) {
            var rows = csv.split('\n')
              , headers = rows.shift().split(',')
              , out;
            rows = _.map(rows, function(row) { return row.split(','); });
            out = _.map(rows, function(row) {
                var obj = {};
                _.each(headers, function(header, i) {
                    obj[header] = row[i];
                });
                return obj;
            });
            return out;
        }

    });

    </script>

  </body>
</html>
