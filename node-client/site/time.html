<!DOCTYPE html>
<html>
<head>

  <link href="{{baseurl}}/bower_components/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="{{baseurl}}/css/map.css" rel="stylesheet">
  <link href="{{baseurl}}/css/time.css" rel="stylesheet">
  <link href="{{baseurl}}/js/external/jQRangeSlider-5.7.1/css/iThing.css" type="text/css" rel="stylesheet" />

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <script src="{{baseurl}}/bower_components/lodash/lodash.min.js"></script>
  <script src="{{baseurl}}/bower_components/async/lib/async.js"></script>
  <script src="{{baseurl}}/bower_components/handlebars/handlebars.min.js"></script>
  <script src="{{baseurl}}/bower_components/moment/min/moment.min.js"></script>
  <script src="{{baseurl}}/bower_components/moment-timezone/builds/moment-timezone-with-data.min.js"></script>
  <script src="{{baseurl}}/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>

  <script src="{{baseurl}}/bower_components/jquery-ui/jquery-ui.min.js"></script>

  <script src="{{baseurl}}/js/external/jQRangeSlider-5.7.1/jQDateRangeSlider-min.js"></script>

  <script src="{{baseurl}}/js/utils.js"></script>
  <script src="{{baseurl}}/js/map.js"></script>

  <script type="text/javascript"
    src="https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=true&libraries=places&key={{ googleApiKey }}">
  </script>
  <title></title>
</head>
  <body>

  <div class="container">
      <div id="loading" class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
              <h1>Loading, please wait...</h1>
              <p>All the historical anomaly values for each route on this map are loading from the server right now. Once complete, you can use the date/time slider at the top of the page to scroll through time and see which routes are most anomolous.</p>
          </div>
        </div>
      </div>
  </div>

    <div id="title">
        <h1>All Routes</h1>
        <h4><a href="{{ baseurl }}">HOME</a></h4>
        <p>Each route has a marker at its first point. Click it to get more details.</p>
    </div>

    <input id="pac-input" class="controls" type="text" placeholder="Search Box">

    <div id="slider"></div>
    <div id="map-canvas"></div>

    <script type="text/javascript">

    $(function() {

        var TZ = 'America/New_York'
          , markerTemplate
          , pageTitle
          , mapOptions
          , query
          , map
          , $loading
          , now = moment()
          , $slider = $('#slider')
          ;

        moment.tz.setDefault(TZ);

        $.get('{{ baseurl }}/templates/markerLabel.hbt', function(response) {
            markerTemplate = response;
        });

        query = getUrlVars();

        if (query.borough) {
            query.borough = query.borough.replace('%20',' ')
            pageTitle = 'Map of ' + query.borough;
        } else if (query.id) {
            pageTitle = 'Map of route(s): ' + query.id;
        }

        $('#title h1').html(pageTitle);
        $('title').html(pageTitle);
        $loading = $('#loading').modal({
            keyboard: false
        });

        map = new TrafficMap('map-canvas', '{{baseurl}}', {
            center: { lat: 40.7903, lng: -73.9597}
          , zoom: 11
        });

        // SLIDER
        sliderOpts = {
            bounds: {
                min: moment(now).subtract(2, 'days').toDate()
              , max: now.toDate()
            }
          , defaultValues: {
                min: moment(now).subtract(3, 'hours').toDate()
              , max: now.toDate()
            }
          , formatter: function(val){
              return moment(val).format('MMM D HH:mm');
            }
        };

        $slider.dateRangeSlider(sliderOpts);

        $loading.show();
        $.getJSON('{{ baseurl }}/data/pathDetails', query, function(data) {
            var minMax = $slider.dateRangeSlider('values')
              , min = moment(minMax.min).tz(TZ)
              , max = moment(minMax.max).tz(TZ)
              , pathFetchers = {};

            map.enableSearchBox('pac-input');
            map.enableRightClickSearch();
            map.setRoutePaths(data.paths, markerTemplate);

            _.each(map.routes, function(rte) {
                var color;
                pathFetchers[rte.id] = function(callback) {
                    $.get('{{ baseurl }}/data/' + rte.id, function(csv) {
                        rte.data = csvStringToData(csv);
                        callback();
                    });
                };
                color = getGreenToRed(0);
                rte.line.setOptions({strokeColor: '#' + color});
            });

            async.parallel(pathFetchers, function(err) {
                if (err) throw err;
                applyTimeWindowAnomalyColoring(map.routes, min, max);
                map.setMinMaxTime(min, max);
                $loading.hide();
                $('.modal-backdrop').remove();
                $('body').removeClass('modal-open');
            });

            $slider.bind('valuesChanging', function(e, data) {
                var min = moment(data.values.min).tz(TZ)
                  , max = moment(data.values.max).tz(TZ)
                  ;
                applyTimeWindowAnomalyColoring(map.routes, min, max);
                map.setMinMaxTime(min, max);
            });

        });

        function getMaxAnomalyScoreInRouteDataBetween(data, min, max) {
            var maxAnomaly = 0.0;
            _.each(data, function(point) {
                var t = point.timestamp;
                // console.log('%s < %s < %s (%s)', min, t, max, point.timestamp);
                if (min < t && t < max) {
                    if (point.anomaly > maxAnomaly) {
                        maxAnomaly = point.anomaly;
                    }
                }
            });
            return maxAnomaly;
        }

        function applyTimeWindowAnomalyColoring(routes, min, max) {
            _.each(routes, function(route) {
                var data = route.data
                  , maxAnomaly = getMaxAnomalyScoreInRouteDataBetween(
                      data, min, max
                    )
                  , color = getGreenToRed(maxAnomaly * 100);
                route.line.setOptions({strokeColor: '#' + color});
            });
        }

        function dateStringToMomentWithZone(timeIn, zone) {
            // 2015/07/01 18:04:03
            var dateString = timeIn.split(' ').shift()
              , timeString = timeIn.split(' ').pop()
              , datePieces = dateString.split('/')
              , timePieces = timeString.split(':')
              , timeObject = {}
              , timestamp
              ;

            timeObject.year = parseInt(datePieces.shift())
            timeObject.month = parseInt(datePieces.shift()) - 1
            timeObject.day = parseInt(datePieces.shift())

            timeObject.hour = parseInt(timePieces.shift())
            timeObject.minute = parseInt(timePieces.shift())
            timeObject.second = parseInt(timePieces.shift())

            return moment.tz(timeObject, zone);
        }

        function csvStringToData(csv) {
            var rows = csv.trim().split('\n')
              , headers = rows.shift().split(',')
              , out;
            rows = _.map(rows, function(row) { return row.split(','); });
            out = _.map(rows, function(row) {
                var obj = {};
                _.each(headers, function(header, i) {
                    if (header == 'timestamp') {
                        obj[header] = dateStringToMomentWithZone(row[i], TZ)
                    } else {
                        obj[header] = parseFloat(row[i]);
                    }
                });
                return obj;
            });
            return out;
        }

    });

    </script>

  </body>
</html>
